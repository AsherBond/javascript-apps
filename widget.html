<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="template.js"></script>
<script src="htmlparser.js"></script>
<script src="json2.js"></script>
<script src="api_key.js"></script>
<script>
  function api_call(path, params) {
    return "http://api.meetup.com/" + path + "?callback=?&" + $.param($.extend({ key: $api_key, sign: true }, params));
  }
  var github = "http://github.com/api/v2/json/";
  var widgetrepo = "widgets";
  var cbq = "?callback=?";
  $(function() {
    $.getJSON(github + "commits/list/meetup/" + widgetrepo + "/master" + cbq, function(json) {
      var head = json.commits[0].id
      $.getJSON(github + "tree/show/meetup/" + widgetrepo + "/" + head + cbq, function(json) {
        $.each(json.tree, function(i, item) {
          if (item.name.match(/.html$/))
            $.getJSON(github + "blob/show/meetup/" + widgetrepo + "/" + head + "/" + item.name + cbq, function(json) {
              var results = "";
              var config = "";
              var MARKER = "<!--widget-config-->";
              HTMLParser(json.blob.data, {
                start: function( tag, attrs, unary ) {
                  var src = $.grep(attrs, function(attr) { return attr.name == "src" } )[0];
                  var id = $.grep(attrs, function(attr) { return attr.name == "id" } )[0];
                  if (tag == "script" && src && !src.value.match(/^http/)) {
                    this.chars = $.noop;
                    this.end = $.noop;
                  } else if (tag == "script" && id && id.value == "config") {
                    this.chars = function(text) {
                      config = text;
                      results += MARKER;
                      this.chars = $.noop;
                    };
                    this.end = $.noop;
                  } else {
                    this.chars = function(text) { results += text; };
                    this.end = function( tag ) { results += "</" + tag + ">"; };
                    results += "<" + tag;
                    for ( var i = 0; i < attrs.length; i++ )
                      results += " " + attrs[i].name + '="' + attrs[i].escaped + '"';
                    results += (unary ? "/" : "") + ">";
                  }
                }
              });
              eval(config);
              var params = "";
              for (name in $parameters) {
                params += parseTemplate($("#parameter").html(), { name: name, value: $parameters[name] });
              }
              var listing = $(parseTemplate($("#listing").html(), { 
                name: json.blob.name, params: params, body: results
              }));
              $("#results").append(listing);
              var sync = function() {
                $parameters[this.name] = $(this).val();
                listing.find("textarea").val(
                  results.replace(MARKER, parseTemplate($("#config_t").html(), { 
                    params: JSON.stringify($parameters)
                  }))
                );
              };
              listing.find("input.param").keyup(sync).each(sync);
            });
        });
      });
    });
  });
</script>
<script id="config_t" type="text/html">
  <script id="config">
    $parameters = <#= params #>;
  </<#= "script"#>>
</script>
<script id="parameter" type="text/html">
  <div>
    <#= name #>
    <input type="text" class="param" name="<#= name #>" value="<#= value #>" />
  </div>
</script>
<script id="listing" type="text/html">
  <h3><#= name #></h3>
  <form>
    <#= params #>
    <textarea></textarea> 
  </form>
</script>
<body>
  <div id="results"></div>
</body>
</html>
