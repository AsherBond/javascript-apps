<html>
<head>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.4.2/jquery.min.js"></script>
<script src="template.js"></script>
<script src="htmlparser.js"></script>
<script src="json2.js"></script>
<script src="api_key.js"></script>
<script>
  var github = "http://github.com/api/v2/json/";
  var widgetrepo = "widgets";
  var cbq = "?callback=?";
  $(function() {
    $.getJSON(github + "commits/list/meetup/" + widgetrepo + "/master" + cbq, function(json) {
      var head = json.commits[0].id
      $.getJSON(github + "tree/show/meetup/" + widgetrepo + "/" + head + cbq, function(json) {
        $.each(json.tree, function(i, item) {
          if (item.name.match(/.html$/))
            $.getJSON(github + "blob/show/meetup/" + widgetrepo + "/" + head + "/" + item.name + cbq, function(json) {
              var results = "";
              var config = "";
              var MARKER = "<!--widget-config-->";
              HTMLParser(json.blob.data, {
                start: function( tag, attrs, unary ) {
                  var src = $.grep(attrs, function(attr) { return attr.name == "src" } )[0];
                  var id = $.grep(attrs, function(attr) { return attr.name == "id" } )[0];
                  if (tag == "script" && src && !src.value.match(/^http/)) {
                    this.chars = $.noop;
                    this.end = $.noop;
                  } else if (tag == "script" && id && id.value == "config") {
                    this.chars = function(text) {
                      config = text;
                      results += MARKER;
                      this.chars = $.noop;
                    };
                    this.end = $.noop;
                  } else {
                    this.chars = function(text) { results += text; };
                    this.end = function(tag) { results += "</" + tag + ">"; };
                    results += "<" + tag;
                    for ( var i = 0; i < attrs.length; i++ )
                      results += " " + attrs[i].name + '="' + attrs[i].escaped + '"';
                    results += (unary ? "/" : "") + ">";
                  }
                }
              });
              var api_call = function(path, params) {
                return "http://api.meetup.com/" + path + "?callback=?&" + $.param($.extend({ key: $api_key, sign: true }, params));
              };
              eval(config);
              var params = "";
              for (name in $parameters) {
                params += parseTemplate($("#parameter").html(), { name: name, value: $parameters[name] });
              }
              var listing = $(parseTemplate($("#listing").html(), { 
                name: json.blob.name, 
                params: params, 
                body: results
              }));
              $("#results").append(listing);
              var with_html = function(block) {
                listing.find("input.param").each(function() {
                  $parameters[this.name] = $(this).val();
                });
                var lookups = 0;
                for (i in $queries) { lookups++; }
                var query_ary = [];
                $.each($queries, function(name, query) {
                  $.getJSON(query(), function(data) {
                    var query = data.meta.signed_url.replace(/&callback=[^&]+/, '&callback=?');
                    query_ary.push(name + ": function() { return \"" + query + "\"; }");
                    if (query_ary.length == lookups) {
                      block(results.replace(MARKER, parseTemplate($("#config_t").html(), { 
                        params: JSON.stringify($parameters),
                        queries: query_ary.join(", ")
                      })));
                    }
                  });
                });
              };
              listing.find("input.create").click(function() {
                with_html(function(html) {
                  var iframe = $('<iframe style="width: 520px; height: 300px; border: 0" frameborder="no" />');
                  listing.find("div.frametarget").empty().append(iframe);
                  var doc = iframe[0].contentWindow.document;
                  doc.open();
                  doc.write(html);
                  doc.close();
                });
                return false;
              });
            });
        });
      });
    });
  });
</script>
<script id="config_t" type="text/html">
  <script id="config">
    var $parameters = <#= params #>;
    var $queries = { <#= queries #> };
  </<#= "script"#>>
</script>
<script id="parameter" type="text/html">
  <div>
    <#= name #>
    <input type="text" class="param" name="<#= name #>" value="<#= value #>" />
  </div>
</script>
<script id="listing" type="text/html">
  <div class="listing">
    <h3><#= name #></h3>
    <form>
      <#= params #>
      <input class="create" value="Create" type="submit" />
    </form>
    <div class="frametarget" />
  </div>
</script>
<body>
  <div id="results"></div>
</body>
</html>
